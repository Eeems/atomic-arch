name: Build images
on:
  pull_request: &on-filter
    branches:
      - master
    paths:
      - .github/workflows/build.yaml
      - .github/workflows/build-variant.yaml
      - ".github/actions/cleanup/**"
      - make.py
      - seccomp.json
      - .contianerignore
      - "overlay/**"
      - "templates/**"
      - "variants/**"
  push: *on-filter
  workflow_dispatch:
  schedule:
    - cron: "0 23 * * *"

jobs:
  notifications:
    name: Clear notifications
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Clean cancellation notifications
        uses: ./.github/actions/clean-cancelled-notifications
        with:
          pat: ${{ secrets.NOTIFICATION_PAT }}

  check:
    name: Ensure config is valid
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    container:
      image: ghcr.io/eeems/atomic-arch-builder:latest
      options: >-
        --privileged
        --security-opt seccomp=unconfined
        --security-opt apparmor=unconfined
        --cap-add=SYS_ADMIN
        --cap-add=NET_ADMIN
        --device /dev/fuse
        --tmpfs /tmp
        --tmpfs /run
        --userns=host
        -v /var/lib/containers:/var/lib/containers
        -v /:/run/host
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Cache venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ hashFiles('.github/workflows/Dockerfile.builder') }}-${{ hashFiles('make.py') }}
      - name: Ensure config is valid
        run: ./make.py check
        env:
          TMPDIR: ${{ runner.temp }}

  rootfs:
    name: Build atomic-arch:rootfs image
    needs: check
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: &permissions
      contents: write
      actions: write
      packages: write
      security-events: write
    with:
      variant: rootfs

  base:
    name: Build atomic-arch:base image
    needs: rootfs
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: base
      updates: ${{ fromJson(needs.rootfs.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  base-nvidia:
    name: Build atomic-arch:base-nvidia image
    needs: base
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: base-nvidia
      updates: ${{ fromJson(needs.base.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  base-slim:
    name: Build atomic-arch:base-slim image
    needs: base
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: base-slim
      updates: ${{ fromJson(needs.base.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}
      cleanup: true

  atomic:
    name: Build atomic-arch:atomic image
    needs: base
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: atomic
      updates: ${{ fromJson(needs.base.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  atomic-nvidia:
    name: Build atomic-arch:atomic-nvidia image
    needs: atomic
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: atomic-nvidia
      updates: ${{ fromJson(needs.atomic.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  atomic-slim:
    name: Build atomic-arch:atomic-slim image
    needs: atomic
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: atomic-slim
      updates: ${{ fromJson(needs.atomic.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}
      cleanup: true

  atomic-system76:
    name: Build atomic-arch:atomic-system76 image
    needs: atomic
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: atomic-system76
      updates: ${{ fromJson(needs.atomic.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  atomic-system76-nvidia:
    name: Build atomic-arch:atomic-system76-nvidia image
    needs: atomic-system76
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: atomic-system76-nvidia
      updates: ${{ fromJson(needs.atomic-system76.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  gnome:
    name: Build atomic-arch:gnome image
    needs: base
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: gnome
      updates: ${{ fromJson(needs.base.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  gnome-nvidia:
    name: Build atomic-arch:gnome-nvidia image
    needs: gnome
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: gnome-nvidia
      updates: ${{ fromJson(needs.gnome.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  gnome-slim:
    name: Build atomic-arch:gnome-slim image
    needs: gnome
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: gnome-slim
      updates: ${{ fromJson(needs.gnome.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}
      cleanup: true

  gnome-system76:
    name: Build atomic-arch:gnome-system76 image
    needs: gnome
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: gnome-system76
      updates: ${{ fromJson(needs.gnome.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  gnome-system76-nvidia:
    name: Build atomic-arch:gnome-system76-nvidia image
    needs: gnome-system76
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: gnome-system76-nvidia
      updates: ${{ fromJson(needs.gnome-system76.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  eeems:
    name: Build atomic-arch:eeems image
    needs: atomic
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: eeems
      updates: ${{ fromJson(needs.atomic.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  eeems-nvidia:
    name: Build atomic-arch:eeems-nvidia image
    needs: eeems
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: eeems-nvidia
      updates: ${{ fromJson(needs.eeems.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  eeems-slim:
    name: Build atomic-arch:eeems-slim image
    needs: eeems
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: eeems-slim
      updates: ${{ fromJson(needs.eeems.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}
      cleanup: true

  eeems-system76:
    name: Build atomic-arch:eeems-system76 image
    needs: eeems
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: eeems-system76
      updates: ${{ fromJson(needs.eeems.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}

  eeems-system76-nvidia:
    name: Build atomic-arch:eeems-system76-nvidia image
    needs: eeems-system76
    uses: ./.github/workflows/build-variant.yaml
    secrets: inherit
    permissions: *permissions
    with:
      variant: eeems-system76-nvidia
      updates: ${{ fromJson(needs.eeems-system76.outputs.updates) }}
      push: ${{ github.ref_name == 'master' }}
