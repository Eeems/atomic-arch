name: Build images
on:
  pull_request: &on-filter
    branches:
      - master
    paths:
      - .github/workflows/build.yaml
      - .github/actions/cleanup
      - .github/actions/build
      - make.py
      - seccomp.json
      - .contianerignore
      - overlay
      - templates
      - variants
  push: *on-filter
  workflow_dispatch:
  schedule:
    - cron: "0 23 * * *"

jobs:
  check:
    name: Ensure config is valid
    runs-on: ubuntu-latest
    container: &builder
      image: docker.io/eeems/atomic-arch:_builder
      options: >-
        --privileged
        --security-opt seccomp=unconfined
        --security-opt apparmor=unconfined
        --cap-add=SYS_ADMIN
        --cap-add=NET_ADMIN
        --device /dev/fuse
        --tmpfs /tmp
        --tmpfs /run
        -v /var/lib/containers:/var/lib/containers
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Force pyenv python
        run: echo "PATH=/opt/pyenv/shims:/opt/pyenv/bin:$PATH" >> $GITHUB_ENV
      - name: Cache venv
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ hashFiles('.github/workflows/Dockerfile.builder') }}-${{ hashFiles('make.py') }}
      - name: Ensure config is valid
        run: sudo ./make.py check
  rootfs:
    name: Build atomic-arch:rootfs
    runs-on: ubuntu-latest
    container: *builder
    needs: [check]
    permissions:
      contents: write
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Build
        uses: ./.github/actions/build
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          image: rootfs
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            Automated rootfs update
            skip-checks:true
  base:
    name: atomic-arch:base image
    runs-on: ubuntu-latest
    container: *builder
    needs: [rootfs]
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Build
        uses: ./.github/actions/build
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          image: base
          updates: ${{ needs.rootfs.outputs.Updates}}
  atomic:
    name: atomic-arch:atomic image
    runs-on: ubuntu-latest
    container: *builder
    needs: [base]
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Build
        uses: ./.github/actions/build
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          image: atomic
          updates: ${{ needs.base.outputs.Updates}}
  gnome:
    name: atomic-arch:gnome image
    runs-on: ubuntu-latest
    container: *builder
    needs: [base]
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Build
        uses: ./.github/actions/build
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          image: gnome
          updates: ${{ needs.base.outputs.Updates}}
  eeems:
    name: atomic-arch:eeems image
    runs-on: ubuntu-latest
    container: *builder
    needs: [atomic]
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Build
        uses: ./.github/actions/build
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          image: eeems
          updates: ${{ needs.atomic.outputs.Updates}}
  system76:
    name: atomic-arch:${{ matrix.variant }}-system76
    runs-on: ubuntu-latest
    container: *builder
    strategy:
      fail-fast: false
      matrix:
        variant:
          - atomic
          - gnome
          - eeems
    needs:
      - base
      - atomic
      - gnome
      - eeems
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Build
        uses: ./.github/actions/build
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          image: ${{ matrix.variant }}-system76
          updates: ${{ needs[matrix.variant].outputs.Updates}}
  nvidia:
    name: atomic-arch:${{ matrix.variant }}-nvidia
    runs-on: ubuntu-latest
    container: *builder
    strategy:
      fail-fast: false
      matrix:
        variant:
          - base
          - atomic
          - gnome
          - eeems
          - atomic-system76
          - gnome-system76
          - eeems-system76
    needs:
      - base
      - atomic
      - gnome
      - eeems
      - system76
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Build
        uses: ./.github/actions/build
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          image: ${{ matrix.variant }}-nvidia
          updates: ${{ needs[matrix.variant].outputs.Updates}}
  slim:
    name: atomic-arch:${{ matrix.variant }}-slim
    runs-on: ubuntu-latest
    container: *builder
    strategy:
      fail-fast: false
      matrix:
        variant:
          - base
          - atomic
          - gnome
          - eeems
          - atomic-system76
          - gnome-system76
          - eeems-system76
    needs:
      - base
      - atomic
      - gnome
      - eeems
      - system76
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - name: Build
        uses: ./.github/actions/build
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          image: ${{ matrix.variant }}-slim
          updates: ${{ needs[matrix.variant].outputs.Updates}}
  iso:
    name: atomic-arch:${{ matrix.variant }}${{ matrix.subvariant }} iso
    runs-on: ubuntu-latest
    container: *builder
    strategy:
      fail-fast: false
      matrix:
        variant:
          - base
          - atomic
          - gnome
          - eeems
          - atomic-system76
          - gnome-system76
          - eeems-system76
        subvariant:
          - ""
          - -nvidia
          - -slim
    needs:
      - base
      - atomic
      - gnome
      - eeems
      - system76
      - nvidia
      - slim
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Login to dockerhub
        uses: redhat-actions/podman-login@v1
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          registry: docker.io
      - name: Install dependencies
        uses: Eeems-Org/apt-cache-action@v1
        with:
          packages: >
            ostree
            podman
            libdbus-1-dev
            libdbus-glib-1-dev
      - name: Install python dependencies
        run: |
          pip install dbus-python
      - name: Add pacman cache
        run: |
          sudo mkdir -p \
            /var/cache/pacman \
            /var/lib/pacman \
            /etc/pacman.d/gnupg
      - name: Clean up system
        run: |
          rm -rf .git/
          docker system prune --force
          docker rmi $(docker image ls -aq) || true
          docker system prune --force
          export DEBIAN_FRONTEND="noninteractive"
          sudo apt-get autoremove -y
          sudo apt-get autoclean -y
      - name: Build
        run: |
          if [ ! -f /etc/containers/seccomp.json ];then
            sudo cp seccomp.json /etc/containers/seccomp.json
          fi
          sudo ./make.py iso ${{ matrix.variant }}${{ matrix.subvariant }}
      - name: Upload iso
        uses: actions/upload-artifact@v4
        with:
          name: atomic-arch-${{ matrix.variant }}${{ matrix.subvariant }}.iso
          path: /var/lib/system/atomic-arch-${{ matrix.variant }}${{ matrix.subvariant }}-*.iso
