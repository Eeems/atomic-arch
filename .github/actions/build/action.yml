name: Build an image
inputs:
  image:
    description: Image to build
    required: true
  username:
    description: Docker username
    required: true
  password:
    description: Docker password
    required: true
  updates:
    description: If previous builds had an update
    required: false
    type: boolean
    default: true
runs:
  using: "composite"
  steps:
    - name: Login to dockerhub
      uses: redhat-actions/podman-login@v1
      with:
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}
        registry: docker.io
    - name: Add pacman cache
      shell: bash
      run: |
        sudo mkdir -p \
          /var/cache/pacman \
          /var/lib/pacman \
          /etc/pacman.d/gnupg
    - name: Build
      id: build
      shell: bash
      run: |
        sudo mkdir -p /var/lib/containers/storage
        sudo chown -R 1001:0 /var/lib/containers/storage
        if [[ "$updates" == "true" ]]; then
            echo "Previous image updated"
            res = 2
          else
            set +e
            sudo ./make.py checkupdates --target=${{ inputs.image }}
            res=$?
            set -e
          fi
          if [ $res -eq 2 ];then
            sudo ./make.py build --push ${{ inputs.image }}
            echo "Updates=true" >> $GITHUB_OUTPUT
          elif [ $res -ne 0 ];then
            exit 1
          else
            sudo ./make.py push ${{ inputs.image }}
            echo "No Updates"
            echo "Updates=false" >> $GITHUB_OUTPUT
          fi
      env:
        updates: ${{ inputs.updates }}
        TMPDIR: ${{ runner.temp }}
