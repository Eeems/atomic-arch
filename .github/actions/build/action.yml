name: Build an image
inputs:
  image:
    description: Image to build
    required: true
  username:
    description: Docker username
    required: true
  password:
    description: Docker password
    required: true
  updates:
    description: If previous builds had an update
    required: false
    type: boolean
    default: true
runs:
  using: "composite"
  steps:
    - name: Ensure .docker exists
      shell: bash
      run: |
        mkdir -p /github/home/.docker
        if ! [ -f /github/home/.docker/config.json ];then
          echo "{}" > /github/home/.docker/config.json
        fi
    - name: Login to dockerhub
      uses: redhat-actions/podman-login@v1
      with:
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}
        registry: docker.io
        auth_file_path: /run/containers/0/auth.json
    - name: Build
      id: build
      shell: bash
      run: |
        if [[ "$updates" == "true" ]]; then
            echo "Previous image updated"
            res = 2
          else
            set +e
            ./make.py checkupdates --target=${{ inputs.image }}
            res=$?
            set -e
          fi
          if [ $res -eq 2 ];then
            ./make.py build --push ${{ inputs.image }}
            echo "Updates=true" >> $GITHUB_OUTPUT
          elif [ $res -ne 0 ];then
            exit 1
          else
            ./make.py push ${{ inputs.image }}
            echo "No Updates"
            echo "Updates=false" >> $GITHUB_OUTPUT
          fi
      env:
        updates: ${{ inputs.updates }}
        TMPDIR: ${{ runner.temp }}
