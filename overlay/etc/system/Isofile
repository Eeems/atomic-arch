ARG BASE_IMAGE=atomic-arch:base

FROM ${BASE_IMAGE}

ARG UUID

RUN <<EOT
  set -e
  mkdir -p \
    /etc/systemd/system/getty@tty1.service.d \
    /etc/mkinitcpio.conf.d \
    /etc/mkinitcpio.d
  useradd -m live
  passwd -d live
  echo "live ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/live
  if [ -f /usr/bin/gdm ]; then
    mkdir -p /etc/gdm
    echo "[daemon]" > /etc/gdm/custom.conf
    echo "AutomaticLoginEnable=True" >> /etc/gdm/custom.conf
    echo "AutomaticLogin=live" >> /etc/gdm/custom.conf
  fi
EOT

RUN <<EOF cat > /etc/mkinitcpio.conf.d/archiso.conf
MODULES=(virtio virtio_blk virtio_pci virtio_net)
BINARIES=()
FILES=()
HOOKS=(base udev microcode modconf kms memdisk archiso archiso_loop_mnt archiso_pxe_common archiso_pxe_nbd archiso_pxe_http archiso_pxe_nfs block filesystems keyboard)
COMPRESSION="xz"
COMPRESSION_OPTIONS=(-9e)
EOF

RUN <<EOF cat > /etc/mkinitcpio.d/linux-zen.preset
# mkinitcpio preset file for the 'linux' package on archiso
PRESETS=('archiso')

ALL_kver='/boot/vmlinuz-linux-zen'
archiso_config='/etc/mkinitcpio.conf.d/archiso.conf'
archiso_image="/boot/initramfs-linux-zen.img"
EOF

RUN <<EOF cat > /etc/systemd/system/getty@tty1.service.d/autologin.conf
[Service]
ExecStart=
ExecStart=-/sbin/agetty -o '-p -f -- \\u' --noclear --autologin live %I linux
EOF

RUN <<EOT
  set -e
  pacman-key --init
  pacman-key --populate archlinux
  pacman -Syu --needed --noconfirm \
    arch-install-scripts \
    dosfstools \
    edk2-shell \
    grub \
    man-db \
    man-pages \
    memtest86+ \
    memtest86+-efi \
    mkinitcpio-archiso \
    mtools \
    qemu-guest-agent \
    syslinux
  yes | pacman -Scc
  rm -rf etc/pacman.d/gnupg/{openpgp-revocs.d/,private-keys-v1.d/,pubring.gpg~,gnupg.S.}*
EOT

RUN <<EOT
  set -e
  touch /etc/system/archiso/${UUID}.uuid
  truncate -s 32MB /etc/system/efiboot.img
  mkfs.vfat /etc/system/efiboot.img
  mmd -i /etc/system/efiboot.img EFI EFI/boot
  grub-mkstandalone \
    --format=x86_64-efi \
    --themes="" \
    --sbat=/usr/share/grub/sbat.csv \
    --disable-shim-lock \
    --output=BOOTx64.EFI \
    boot/grub/grub.cfg=./grub.cfg
  mcopy -i /etc/system/efiboot.img BOOTx64.EFI ::EFI/boot
  rm BOOTx64.EFI
  grub-mkimage \
    --output=core.img \
    --prefix=/boot/grub \
    --format=i386-pc \
    all_video \
    at_keyboard \
    boot \
    btrfs \
    biosdisk \
    iso9660 \
    multiboot \
    configfile \
    echo \
    halt \
    reboot \
    exfat \
    ext2 \
    linux \
    ntfs \
    usb \
    sleep \
    xfs \
    zstd
  mkdir -p \
    /etc/system/archiso/boot/grub \
    /etc/system/archiso/atomic/x86_64
  cat /usr/lib/grub/i386-pc/cdboot.img core.img > /etc/system/archiso/boot/grub/eltorito.img
  rm core.img
  cp -a /boot/vmlinuz-linux-zen /etc/system/archiso/atomic/x86_64
  cp -a /boot/initramfs-linux-zen.img /etc/system/archiso/atomic/x86_64
EOT
