ARG BASE_IMAGE=atomic-arch:base

FROM ${BASE_IMAGE}

ARG UUID

RUN <<EOT
  set -e
  pacman-key --init
  pacman-key --populate archlinux
  pacman -Syu --needed --noconfirm \
    efibootmgr \
    grub \
    mkinitcpio-archiso \
    qemu-guest-agent \
    syslinux
  yes | pacman -Scc
  rm -rf etc/pacman.d/gnupg/{openpgp-revocs.d/,private-keys-v1.d/,pubring.gpg~,gnupg.S.}*
EOT

RUN <<EOF cat > /etc/system/mkinitcpio.conf
MODULES=(virtio virtio_blk virtio_pci virtio_net)
BINARIES=()
FILES=()
HOOKS=(base udev modconf memdisk archiso archiso_loop_mnt kms block filesystems keyboard)
EOF

RUN <<EOT
  set -e
  mkdir -p \
    /iso/arch/x86_64 \
    /iso/arch/boot/x86_64 \
    /iso/arch/boot/grub \
    /iso/boot/grub
  mkinitcpio \
    -k /boot/vmlinuz-linux-zen \
    -c /etc/system/mkinitcpio.conf \
    -g /iso/arch/boot/x86_64/initramfs.img
EOT

RUN <<EOF cat > /iso/boot/grub/grub.cfg
insmod part_gpt
insmod part_msdos
insmod fat
insmod iso9660
insmod ntfs
insmod ntfscomp
insmod exfat
insmod udf

set UUID=${UUID}

search --file --set=root /boot/\${UUID}.uuid

if loadfont "\${prefix}/fonts/unicode.pf2" ; then
    insmod all_video
    set gfxmode="auto"
    terminal_input console
    terminal_output console
fi

default=archlinux
timeout=15
timeout_style=menu

menuentry "Boot atomic-arch" --class arch --class gnu-linux --class gnu --class os --id 'archlinux' {
    set gfxpayload=keep
    linux /arch/boot/x86_64/vmlinuz-linux-zen archisobasedir=arch archisosearchuuid=\${UUID} copytoram=n
    initrd /arch/boot/x86_64/initramfs.img
}
menuentry "Boot atomic-arch (nomodeset)" --class arch --class gnu-linux --class gnu --class os --id 'archlinux' {
    set gfxpayload=keep
    linux /arch/boot/x86_64/vmlinuz-linux-zen nomodeset archisobasedir=arch archisosearchuuid=\${UUID} copytoram=n
    initrd /arch/boot/x86_64/initramfs.img
}
menuentry 'System shutdown' --class shutdown --class poweroff {
    echo 'System shutting down...'
    halt
}
menuentry 'System restart' --class reboot --class restart {
    echo 'System rebooting...'
    reboot
}
play 600 988 1 1319 4
EOF

RUN <<EOT
  set -e
  useradd -m live
  passwd -d live
  echo "live ALL=(ALL:ALL) NOPASSWD: ALL" > /etc/sudoers.d/live
  if [ -f /usr/bin/gdm ]; then
    mkdir -p /etc/gdm
    echo "[daemon]" > /etc/gdm/custom.conf
    echo "AutomaticLoginEnable=True" >> /etc/gdm/custom.conf
    echo "AutomaticLogin=live" >> /etc/gdm/custom.conf
  fi
  touch "/boot/${UUID}.uuid"
  cp -al /boot/vmlinuz-linux-zen /iso/arch/boot/x86_64
EOT
